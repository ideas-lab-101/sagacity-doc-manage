<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <link rel="icon" href="/asset/image/cloud_docs.ico">

    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>平台登录</title>
    <link rel="stylesheet" href="/asset/layui/css/layui.css" media="all">
    <!--<link href="/asset/font-awesome/css/font-awesome.min.css" rel="stylesheet">-->
    <link href="/asset/font-icon/font_icon_sagacity.css" rel="stylesheet">
    <link rel="stylesheet" href="/asset/css/login.css" media="all">
</head>
<body class="layui-layout-body bg">
    <div class="layui-layout">

        <div class="login layui-anim layui-anim-fadein">
            <h1>魔灯知库</h1></p>
            <div class="layui-container">
                <div class="layui-row">
                    <div class="layui-col-md2" style="text-align:center; border-right:1px dashed #000; height:150px;">
                        <img class="logo layui-icon-logo" src="asset/image/logo_docs.png" alt=""/>
                    </div>
                    <div class="layui-col-md5" style="margin-left: 30px;">
                        <div class="layui-form">
                            <div class="layui-form-item">
                                <span style="display: inline-block;"><i class="iconfont icon-accountcircle"></i></span>
                                <input class="layui-input" style="display:inline; width: 80%;" type="text" id="username" lay-verify="required" placeholder="请输入账号" autocomplete="off"  value="">
                            </div>
                            <div class="layui-form-item">
                                <span style="display: inline-block;"><i class="iconfont icon-lock-open"></i></span>
                                <input class="layui-input" style="display:inline; width: 80%;" type="password" id="password" lay-verify="required" placeholder="请输入密码" autocomplete="off" value="">
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">记住账号</label>
                                <div class="layui-input-block">
                                    <input type="checkbox" id="ck_rmbUser" lay-skin="switch" lay-text="ON|OFF">
                                </div>
                                <div style="position:absolute; left:120px; bottom: 50px;" id="qrCode"></div>
                            </div>
                            <div class="layui-container">
                                <button style="display: inline-block; vertical-align: middle;" class="layui-btn login_btn" onclick="login()">登陆系统</button>
                                <i class="iconfont icon-qrcode-scan" style="display: inline-block; vertical-align: middle; margin-left: 15px; font-size: 30px;" onclick="qrScan()"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/asset/layui/layui.js" charset="utf-8"></script>
    <script src="/asset/jquery/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="/asset/jquery/jquery.cookie.js"></script>
    <script type="text/javascript" src="/asset/jquery/jquery.qrcode.min.js"></script>
    <script type="text/javascript">

        var layer, form;
        layui.use(['layer','form'], function(){
            layer = layui.layer; //弹层
            form = layui.form;
        })

        function login() {
            setCookie();
            $.ajax({
                url: "login",
                type: "GET",
                dataType: "json",
                data: {
                    username : $("#username").val(),
                    password : $("#password").val()
                },
                success: function(data) {
                    if (data.result) {
                        window.open("index", "_self", "");
                    }else{
                        layer.msg(data.msg, {time:2000, offset: '100px'});
                    }
                }
            });
        }

        function qrScan() {
            var timer;

            if(document.getElementById("qrCode").innerHTML != ""){
                window.clearInterval(timer);
                document.getElementById("qrCode").innerHTML="";
                return;
            }
            //key值
            var key = Date.parse( new Date());
            //二维码字符串
            var qrCodeString = '{ "type":"login", "key":"'+key+'"}';

            jQuery('#qrCode').qrcode({
                render   : "canvas",
                text     :  qrCodeString,
                width : 180,
                height : 180
            });

            //启动timer
            timer = window.setInterval(function(){
                $.ajax({
                    url: "scanLogin",
                    type: "GET",
                    dataType: "json",
                    data: {
                        key: key
                    },
                    success: function(data) {
                        if (data.result) {
                            window.clearInterval(timer);
                            $.ajax({
                                url: "login",
                                type: "POST",
                                dataType: "json",
                                data: {
                                    username : data.user.LoginName,
                                    password : data.user.Password
                                },
                                success: function(data) {
                                    if (data.result) {
                                        window.open("index", "_self", "");
                                    }else{
                                        layer.msg(data.msg, {time:2000, offset: '100px'});
                                    }
                                }
                            });
                        }else{
                            // layer.msg(data.msg, {time:2000, offset: '100px'});
                        }
                    }
                });
            }, 3000);
        }

        function setCookie() {
            if ($("#ck_rmbUser").prop("checked")) {
                var username = $("#username").val();
                var password = $("#password").val();
                $.cookie("rmbUser", "true", { expires: 7 }); //存储一个带7天期限的cookie
                $.cookie("username", username, { expires: 7 });
                $.cookie("password", password, { expires: 7 });
            }else{
                $.cookie("rmbUser", "false", { expire: -1 });
                $.cookie("username", "", { expires: -1 });
                $.cookie("password", "", { expires: -1 });
            }
        }

        $(document).ready(function() {
            if ($.cookie("rmbUser") == "true") {
                $("#ck_rmbUser").prop("checked", true);
                $("#username").val($.cookie("username"));
                $("#UserFont").css('display','none');
                $("#password").val($.cookie("password"));
                $("#PasswordFont").css('display','none');
            }

            document.onkeydown = function(e) {
                // 兼容FF和IE和Opera
                var theEvent = e || window.event;
                var code = theEvent.keyCode || theEvent.which || theEvent.charCode;
                if (code == 13 && (document.activeElement.type == 'text' || document.activeElement.type == 'password')) {
                    submitLogin(); //要触发的方法
                    return false;
                }
                return true;
            }
        });

    </script>
</body>
</html>